<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="7Lps-vAOlSEhpqs7Yu8uU3-ftD3HnBCOdmSWtm_CJ1s" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="kubernetes," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="手动安装kubernetes 1.12版本记录。 1.环境准备1.1服务器规划   ip 安装 说明     10.233.1.75 K8S Master、etcd 单Master   10.233.1.240 k8s node、etcd    10.233.1.157 k8s node    10.233.1.99 k8s node、etcd    10.233.1.16 k8s node">
<meta name="keywords" content="kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="手动安装kubernetes 1.12版本记录">
<meta property="og:url" content="http://zaife.me/2018/11/01/manual-install-k8s-1-12/index.html">
<meta property="og:site_name" content="zaife的博客">
<meta property="og:description" content="手动安装kubernetes 1.12版本记录。 1.环境准备1.1服务器规划   ip 安装 说明     10.233.1.75 K8S Master、etcd 单Master   10.233.1.240 k8s node、etcd    10.233.1.157 k8s node    10.233.1.99 k8s node、etcd    10.233.1.16 k8s node">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-11-01T09:52:39.359Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="手动安装kubernetes 1.12版本记录">
<meta name="twitter:description" content="手动安装kubernetes 1.12版本记录。 1.环境准备1.1服务器规划   ip 安装 说明     10.233.1.75 K8S Master、etcd 单Master   10.233.1.240 k8s node、etcd    10.233.1.157 k8s node    10.233.1.99 k8s node、etcd    10.233.1.16 k8s node">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zaife.me/2018/11/01/manual-install-k8s-1-12/"/>





  <title>手动安装kubernetes 1.12版本记录 | zaife的博客</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-67371552-1', 'auto');
  ga('send', 'pageview');
</script>











</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zaife的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">zaife的技术说说</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zaife.me/2018/11/01/manual-install-k8s-1-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zaife">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/32269?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zaife的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">手动安装kubernetes 1.12版本记录</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-01T17:25:51+08:00">
                2018-11-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>手动安装kubernetes 1.12版本记录。</p>
<h1 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1.环境准备"></a>1.环境准备</h1><h2 id="1-1服务器规划"><a href="#1-1服务器规划" class="headerlink" title="1.1服务器规划"></a>1.1服务器规划</h2><table>
<thead>
<tr>
<th>ip</th>
<th>安装</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.233.1.75</td>
<td>K8S Master、etcd</td>
<td>单Master</td>
</tr>
<tr>
<td>10.233.1.240</td>
<td>k8s node、etcd</td>
<td></td>
</tr>
<tr>
<td>10.233.1.157</td>
<td>k8s node</td>
<td></td>
</tr>
<tr>
<td>10.233.1.99</td>
<td>k8s node、etcd</td>
<td></td>
</tr>
<tr>
<td>10.233.1.16</td>
<td>k8s node</td>
<td></td>
</tr>
<tr>
<td>10.233.1.243</td>
<td>k8s node</td>
<td></td>
</tr>
<tr>
<td>10.233.1.128</td>
<td>k8s node</td>
<td></td>
</tr>
<tr>
<td>10.233.1.185</td>
<td>k8s node</td>
<td></td>
</tr>
<tr>
<td>10.233.1.144</td>
<td>k8s node</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="1-2-服务器环境"><a href="#1-2-服务器环境" class="headerlink" title="1.2 服务器环境"></a>1.2 服务器环境</h2><h3 id="1-2-1-关闭selinux"><a href="#1-2-1-关闭selinux" class="headerlink" title="1.2.1 关闭selinux"></a>1.2.1 关闭selinux</h3> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#临时关闭</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment">#永久关闭</span></span><br><span class="line">sed -i <span class="string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</span><br></pre></td></tr></table></figure>
<h3 id="1-2-2-关闭swap"><a href="#1-2-2-关闭swap" class="headerlink" title="1.2.2 关闭swap"></a>1.2.2 关闭swap</h3> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时关闭swap</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment"># 永久关闭 注释/etc/fstab文件里swap相关的行</span></span><br><span class="line">sed -i <span class="string">'s/.*swap.*/#&amp;/'</span> /etc/fstab</span><br></pre></td></tr></table></figure>
<h3 id="1-2-3-防火墙"><a href="#1-2-3-防火墙" class="headerlink" title="1.2.3 防火墙"></a>1.2.3 防火墙</h3> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 开启forward</span></span><br><span class="line"><span class="comment"># Docker从1.13版本开始调整了默认的防火墙规则</span></span><br><span class="line"><span class="comment"># 禁用了iptables filter表中FOWARD链</span></span><br><span class="line"><span class="comment"># 这样会引起Kubernetes集群中跨Node的Pod无法通信</span></span><br><span class="line"></span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置转发相关参数，否则可能会出错</span></span><br><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载ipvs相关内核模块</span></span><br><span class="line"><span class="comment"># 如果重新开机，需要重新加载</span></span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line">modprobe nf_conntrack_ipv4</span><br><span class="line">lsmod | grep ip_vs</span><br></pre></td></tr></table></figure>
<h3 id="1-2-4-host解析"><a href="#1-2-4-host解析" class="headerlink" title="1.2.4 host解析"></a>1.2.4 host解析</h3><p>/etc/hosts</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">10.233.1.75  k8s1</span><br><span class="line">10.233.1.240 k8s2</span><br><span class="line">10.233.1.88  k8s3</span><br><span class="line">10.233.1.157 k8s4</span><br><span class="line">10.233.1.99  k8s5</span><br><span class="line">10.233.1.16  k8s6</span><br><span class="line">10.233.1.243 k8s7</span><br><span class="line">10.233.1.128 k8s8</span><br><span class="line">10.233.1.185 k8s9</span><br><span class="line">10.233.1.144 k8s10</span><br></pre></td></tr></table></figure>
<h3 id="1-2-5-系统参数"><a href="#1-2-5-系统参数" class="headerlink" title="1.2.5 系统参数"></a>1.2.5 系统参数</h3><p>修改 /etc/sysctl.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="2-证书准备"><a href="#2-证书准备" class="headerlink" title="2 证书准备"></a>2 证书准备</h1><p>管理集群的TLS，创建TLS证书，各部分通过证书访问。</p>
<h2 id="2-1-证书列表"><a href="#2-1-证书列表" class="headerlink" title="2.1 证书列表"></a>2.1 证书列表</h2><p>生成的 CA 证书和秘钥文件如下：</p>
<ul>
<li>ca-key.pem</li>
<li>ca.pem</li>
<li>kubernetes-key.pem</li>
<li>kubernetes.pem</li>
<li>kube-proxy.pem</li>
<li>kube-proxy-key.pem</li>
<li>admin.pem</li>
<li>admin-key.pem</li>
</ul>
<p>使用证书的组件如下：</p>
<ul>
<li>etcd：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；</li>
<li>kube-apiserver：使用 ca.pem、kubernetes-key.pem、kubernetes.pem；</li>
<li>kubelet：使用 ca.pem；</li>
<li>kube-proxy：使用 ca.pem、kube-proxy-key.pem、kube-proxy.pem；</li>
<li>kubectl：使用 ca.pem、admin-key.pem、admin.pem；</li>
<li>kube-controller-manager：使用 ca-key.pem、ca.pem</li>
</ul>
<h2 id="2-2-安装CFSSL"><a href="#2-2-安装CFSSL" class="headerlink" title="2.2 安装CFSSL"></a>2.2 安装CFSSL</h2><p>这部分参考</p>
<p><a href="https://kubernetes.io/docs/concepts/cluster-administration/certificates/" target="_blank" rel="noopener">官网</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -o cfssl</span><br><span class="line">chmod +x cfssl</span><br><span class="line">curl -L https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -o cfssljson</span><br><span class="line">chmod +x cfssljson</span><br><span class="line">curl -L https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -o cfssl-certinfo</span><br><span class="line">chmod +x cfssl-certinfo</span><br></pre></td></tr></table></figure>
<h2 id="2-3-证书生成"><a href="#2-3-证书生成" class="headerlink" title="2.3 证书生成"></a>2.3 证书生成</h2><h3 id="2-3-1-创建CA配置文件"><a href="#2-3-1-创建CA配置文件" class="headerlink" title="2.3.1 创建CA配置文件"></a>2.3.1 创建CA配置文件</h3><p>ca-config.json</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/ssl</span><br><span class="line">cd /root/ssl</span><br><span class="line">cfssl print-defaults config &gt; config.json</span><br><span class="line">cfssl print-defaults csr &gt; csr.json</span><br><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"signing"</span>: &#123;</span><br><span class="line">    <span class="attr">"default"</span>: &#123;</span><br><span class="line">      <span class="attr">"expiry"</span>: <span class="string">"8760h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"profiles"</span>: &#123;</span><br><span class="line">      <span class="attr">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="attr">"usages"</span>: [</span><br><span class="line">          <span class="string">"signing"</span>,</span><br><span class="line">          <span class="string">"key encipherment"</span>,</span><br><span class="line">          <span class="string">"server auth"</span>,</span><br><span class="line">          <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"expiry"</span>: <span class="string">"8760h"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>字段说明：</p>
<ul>
<li>ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</li>
<li>server auth：表示client可以用该 CA 对server提供的证书进行验证；</li>
<li>client auth：表示server可以用该CA对client提供的证书进行验证；</li>
</ul>
<h3 id="2-3-2-CA证书签名"><a href="#2-3-2-CA证书签名" class="headerlink" title="2.3.2 CA证书签名"></a>2.3.2 CA证书签名</h3><p>创建<code>ca-csr.json</code>文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="attr">"key"</span>: &#123;</span><br><span class="line">    <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">    <span class="attr">"ca"</span>: &#123;</span><br><span class="line">       <span class="attr">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>“CN”：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
<h3 id="2-3-3-生成CA证书和私钥"><a href="#2-3-3-生成CA证书和私钥" class="headerlink" title="2.3.3 生成CA证书和私钥"></a>2.3.3 生成CA证书和私钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line"></span><br><span class="line">2018/10/26 16:55:46 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line"></span><br><span class="line">▽</span><br><span class="line">&#123;</span><br><span class="line">2018/10/26 16:55:46 [INFO] generate received request</span><br><span class="line">2018/10/26 16:55:46 [INFO] received CSR</span><br><span class="line">2018/10/26 16:55:46 [INFO] generating key: rsa-2048</span><br><span class="line">2018/10/26 16:55:46 [INFO] encoded CSR</span><br><span class="line">2018/10/26 16:55:46 [INFO] signed certificate with serial number 146268839006346800946655524559430919969695592050</span><br></pre></td></tr></table></figure>
<h3 id="2-3-4-创建kubernetes证书"><a href="#2-3-4-创建kubernetes证书" class="headerlink" title="2.3.4 创建kubernetes证书"></a>2.3.4 创建kubernetes证书</h3><p>创建kubernetes证书签名请求文件 <code>kubernetes-csr.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="attr">"hosts"</span>: [</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"10.233.1.75"</span>,</span><br><span class="line">      <span class="string">"10.233.1.240"</span>,</span><br><span class="line">      <span class="string">"10.233.1.157"</span>,</span><br><span class="line">      <span class="string">"10.233.1.99"</span>,</span><br><span class="line">      <span class="string">"10.233.1.16"</span>,</span><br><span class="line">      <span class="string">"10.233.1.243"</span>,</span><br><span class="line">      <span class="string">"10.233.1.128"</span>,</span><br><span class="line">      <span class="string">"10.233.1.185"</span>,</span><br><span class="line">      <span class="string">"10.233.1.144"</span>,</span><br><span class="line">      <span class="string">"172.32.0.1"</span>,</span><br><span class="line">      <span class="string">"kubernetes"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"key"</span>: &#123;</span><br><span class="line">        <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="attr">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="attr">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">            <span class="attr">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">            <span class="attr">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表，由于该证书后续被 etcd 集群和 kubernetes master 集群使用，所以上面分别指定了 etcd 集群、kubernetes master 集群的主机 IP 和 kubernetes 服务的服务 IP（一般是 kube-apiserver 指定的 service-cluster-ip-range 网段的第一个IP，如 10.254.0.1）。</li>
<li>这是最小化安装的kubernetes集群，包括一个私有镜像仓库，三个节点的kubernetes集群，以上物理节点的IP也可以更换为主机名。</li>
</ul>
<h3 id="2-3-5-生成kubernetes证书和私钥"><a href="#2-3-5-生成kubernetes证书和私钥" class="headerlink" title="2.3.5 生成kubernetes证书和私钥"></a>2.3.5 生成kubernetes证书和私钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line"></span><br><span class="line">2018/10/26 17:08:23 [INFO] generate received request</span><br><span class="line">2018/10/26 17:08:23 [INFO] received CSR</span><br><span class="line">2018/10/26 17:08:23 [INFO] generating key: rsa-2048</span><br><span class="line">2018/10/26 17:08:23 [INFO] encoded CSR</span><br><span class="line">2018/10/26 17:08:23 [INFO] signed certificate with serial number 235958939106703223955290958046851161407211974393</span><br><span class="line">2018/10/26 17:08:23 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>
<h3 id="2-3-6-创建admin证书"><a href="#2-3-6-创建admin证书" class="headerlink" title="2.3.6 创建admin证书"></a>2.3.6 创建admin证书</h3><p>创建admin证书签名，<code>admin-csr.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="attr">"hosts"</span>: [],</span><br><span class="line">  <span class="attr">"key"</span>: &#123;</span><br><span class="line">    <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>后续 kube-apiserver 使用 RBAC 对客户端(如 kubelet、kube-proxy、Pod)请求进行授权；</li>
<li>kube-apiserver 预定义了一些 RBAC 使用的 RoleBindings，如 cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用kube-apiserver 的所有 API的权限；</li>
<li>O 指定该证书的 Group 为 system:masters，kubelet 使用该证书访问 kube-apiserver 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 system:masters，所以被授予访问所有 API 的权限；</li>
</ul>
<p><strong>注意</strong>：这个admin 证书，是将来生成管理员用的kube config 配置文件用的，现在我们一般建议使用RBAC 来对kubernetes 进行角色权限控制， kubernetes 将证书中的CN 字段 作为User， O 字段作为 Group（具体参考 Kubernetes中的用户与身份认证授权中 X509 Client Certs 一段）。</p>
<p>在搭建完 kubernetes 集群后，我们可以通过命令: kubectl get clusterrolebinding cluster-admin -o yaml ,查看到 clusterrolebinding cluster-admin 的 subjects 的 kind 是 Group，name 是 system:masters。 roleRef 对象是 ClusterRole cluster-admin。 意思是凡是 system:masters Group 的 user 或者 serviceAccount 都拥有 cluster-admin 的角色。 因此我们在使用 kubectl 命令时候，才拥有整个集群的管理权限。可以使用 kubectl get clusterrolebinding cluster-admin -o yaml 来查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get clusterrolebinding cluster-admin -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  creationTimestamp: 2018-10-30T07:37:10Z</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  resourceVersion: <span class="string">"94"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin</span><br><span class="line">  uid: 9c74250c-dc16-11e8-b223-fa163ea6f6eb</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:masters</span><br></pre></td></tr></table></figure>
<h3 id="2-3-7-生成admin证书和私钥"><a href="#2-3-7-生成admin证书和私钥" class="headerlink" title="2.3.7 生成admin证书和私钥"></a>2.3.7 生成admin证书和私钥</h3><p>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ca]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class="line">2018/10/26 17:11:16 [INFO] generate received request</span><br><span class="line">2018/10/26 17:11:16 [INFO] received CSR</span><br><span class="line">2018/10/26 17:11:16 [INFO] generating key: rsa-2048</span><br><span class="line">2018/10/26 17:11:16 [INFO] encoded CSR</span><br><span class="line">2018/10/26 17:11:16 [INFO] signed certificate with serial number 2252059684795249508611656661315033924388054941</span><br><span class="line">2018/10/26 17:11:16 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br></pre></td></tr></table></figure>
<h3 id="2-3-8-创建kube-proxy证书"><a href="#2-3-8-创建kube-proxy证书" class="headerlink" title="2.3.8 创建kube-proxy证书"></a>2.3.8 创建kube-proxy证书</h3><p>创建<code>kube-proxy-csr.json</code>文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="attr">"hosts"</span>: [],</span><br><span class="line">  <span class="attr">"key"</span>: &#123;</span><br><span class="line">    <span class="attr">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="attr">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>CN 指定该证书的 User 为 system:kube-proxy；</li>
<li>kube-apiserver 预定义的 RoleBinding system:node-proxier 将User system:kube-proxy 与 Role system:node-proxier 绑定，该 Role 授予了调用 kube-apiserver Proxy 相关 API 的权限；</li>
</ul>
<h3 id="2-3-9生成证书和私钥"><a href="#2-3-9生成证书和私钥" class="headerlink" title="2.3.9生成证书和私钥"></a>2.3.9生成证书和私钥</h3><p>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 ca]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">2018/10/26 17:11:56 [INFO] generate received request</span><br><span class="line">2018/10/26 17:11:56 [INFO] received CSR</span><br><span class="line">2018/10/26 17:11:56 [INFO] generating key: rsa-2048</span><br><span class="line">2018/10/26 17:11:56 [INFO] encoded CSR</span><br><span class="line">2018/10/26 17:11:56 [INFO] signed certificate with serial number 379429245514943305834850902468238084124681575100</span><br><span class="line">2018/10/26 17:11:56 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-10-校验证书"><a href="#2-3-10-校验证书" class="headerlink" title="2.3.10 校验证书"></a>2.3.10 校验证书</h3><p>openssl x509  -noout -text -in  kubernetes.pem</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># openssl x509  -noout -text -in  kubernetes.pem</span></span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            35:09:ba:f5:80:ae:96:46:e3:fb:fe:bc:9c:47:10:e5:4c:98:30:f2</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Oct 30 05:56:00 2018 GMT</span><br><span class="line">            Not After : Oct 30 05:56:00 2019 GMT</span><br><span class="line">        Subject: C=CN, ST=BeiJing, L=BeiJing, O=k8s, OU=System, CN=kubernetes</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    ...</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Digital Signature, Key Encipherment</span><br><span class="line">            X509v3 Extended Key Usage:</span><br><span class="line">                TLS Web Server Authentication, TLS Web Client Authentication</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                A9:FA:1C:A8:DF:E7:1B:9A:D1:17:26:E3:C4:4C:8F:2C:19:CD:CF:D2</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:A2:74:21:F8:F8:9E:E8:DE:96:7A:94:35:BA:4D:88:04:E8:5B:1C:A6</span><br><span class="line"></span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:127.0.0.1, IP Address:10.233.1.75, IP Address:10.233.1.240, IP Address:10.233.1.157, IP Address:10.233.1.99, IP Address:10.233.1.16, IP Address:10.233.1.243, IP Address:10.233.1.128, IP Address:10.233.1.185, IP Address:10.233.1.144, IP Address:192.168.0.1</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         ...</span><br></pre></td></tr></table></figure>
<ul>
<li>确认 Issuer 字段的内容和 ca-csr.json 一致；</li>
<li>确认 Subject 字段的内容和 kubernetes-csr.json 一致；</li>
<li>确认 X509v3 Subject Alternative Name 字段的内容和 kubernetes-csr.json 一致；</li>
<li>确认 X509v3 Key Usage、Extended Key Usage 字段的内容和 ca-config.json 中 kubernetes profile 一致；</li>
</ul>
<h3 id="2-3-11-分发证书"><a href="#2-3-11-分发证书" class="headerlink" title="2.3.11 分发证书"></a>2.3.11 分发证书</h3><p>分发证书到各节点的 <code>/etc/kubernetes/ssl</code>目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/ssl</span><br><span class="line">cp *.pem /etc/kubernetes/ssl</span><br></pre></td></tr></table></figure>
<h1 id="3-Etcd安装"><a href="#3-Etcd安装" class="headerlink" title="3 Etcd安装"></a>3 Etcd安装</h1><h2 id="3-1-集群环境"><a href="#3-1-集群环境" class="headerlink" title="3.1 集群环境"></a>3.1 集群环境</h2><table>
<thead>
<tr>
<th>ip</th>
<th>name</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.233.1.75</td>
<td>k8s1</td>
<td>单Master</td>
</tr>
<tr>
<td>10.233.1.240</td>
<td>k8s2</td>
<td></td>
</tr>
<tr>
<td>10.233.1.99</td>
<td>k8s5</td>
<td></td>
</tr>
</tbody>
</table>
<p>分发之前证书，检查 /etc/kubernetes/ssl目录下证书是否存在<br>ca.pem、kubernetes-key.pem、kubernetes.pem</p>
<h2 id="3-2-安装"><a href="#3-2-安装" class="headerlink" title="3.2 安装"></a>3.2 安装</h2><p>下载，选择 3.3.10版本<br><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases</a></p>
<p>解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf etcd-v3.3.10-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<p>移动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv etcd-v3.3.10-linux-amd64 /usr/<span class="built_in">local</span>/etcd</span><br><span class="line">/usr/<span class="built_in">local</span>/etcd --version</span><br></pre></td></tr></table></figure>
<h2 id="3-3-配置文件"><a href="#3-3-配置文件" class="headerlink" title="3.3 配置文件"></a>3.3 配置文件</h2><p>配置<code>/etc/etcd/etcd.conf</code></p>
<p>创建工作文件目录 <code>/var/lib/etcd</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/etcd/etcd.conf</span><br><span class="line"></span><br><span class="line">ETCD_NAME=ETCD Server</span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"http://0.0.0.0:2379"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"http://10.233.1.75:2379"</span></span><br></pre></td></tr></table></figure>
<h2 id="3-4-配置启动脚本"><a href="#3-4-配置启动脚本" class="headerlink" title="3.4 配置启动脚本"></a>3.4 配置启动脚本</h2><p>创建启动服务文件 <code>/usr/lib/systemd/system/etcd.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Etcd Server</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/lib/etcd/</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/etcd/etcd.conf</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/etcd/etcd \</span><br><span class="line">  --name k8s1 --initial-advertise-peer-urls http://10.233.1.75:2380 \</span><br><span class="line">  --listen-peer-urls http://10.233.1.75:2380 \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://10.233.1.75:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster k8s1=http://10.233.1.75:2380,k8s2=http://10.233.1.240:2380,k8s5=http://10.233.1.99:2380 \</span><br><span class="line">  --initial-cluster-state new</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<h2 id="3-5-启动"><a href="#3-5-启动" class="headerlink" title="3.5 启动"></a>3.5 启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd.service</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/etcd.service to /usr/lib/systemd/system/etcd.service.</span><br><span class="line">systemctl start etcd.service</span><br></pre></td></tr></table></figure>
<h2 id="3-6-验证集群状态"><a href="#3-6-验证集群状态" class="headerlink" title="3.6 验证集群状态"></a>3.6 验证集群状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 etcd]<span class="comment"># /usr/local/etcd/etcdctl cluster-health</span></span><br><span class="line">member ced9a2f15f15a447 is healthy: got healthy result from http://10.233.1.75:2379</span><br><span class="line">member cf90ecded6518a21 is healthy: got healthy result from http://10.233.1.99:2379</span><br><span class="line">member e30671ba5196c19a is healthy: got healthy result from http://10.233.1.240:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">[root@k8s1 ~]<span class="comment"># /usr/local/etcd/etcdctl  --ca-file=/etc/kubernetes/ssl/ca.pem --cert-file=/etc/kubernetes/ssl/kubernetes.pem --key-file=/etc/kubernetes/ssl/kubernetes-key.pem cluster-health</span></span><br><span class="line">member 1900e9153ed2ff46 is healthy: got healthy result from https://10.233.1.240:2379</span><br><span class="line">member 4bc09b2ed3fa13d6 is healthy: got healthy result from https://10.233.1.99:2379</span><br><span class="line">member 7c917379841585a7 is healthy: got healthy result from https://10.233.1.75:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>
<h1 id="4-kubernetes之kubectl安装和kubeconfig配置"><a href="#4-kubernetes之kubectl安装和kubeconfig配置" class="headerlink" title="4. kubernetes之kubectl安装和kubeconfig配置"></a>4. kubernetes之kubectl安装和kubeconfig配置</h1><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf kubernetes-client-linux-amd64.tar.gz</span><br><span class="line">cp kubernetes/client/bin/kubectl /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/kubectl</span><br></pre></td></tr></table></figure>
<p>生成配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cp admin.pem admin-key.pem /etc/kubernetes/ssl/</span><br><span class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://10.233.1.75:6443"</span></span><br><span class="line"><span class="comment">#设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials admin \</span><br><span class="line"> --client-certificate=/etc/kubernetes/ssl/admin.pem \</span><br><span class="line"> --embed-certs=<span class="literal">true</span> \</span><br><span class="line"> --client-key=/etc/kubernetes/ssl/admin-key.pem</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context kubernetes \</span><br><span class="line"> --cluster=kubernetes \</span><br><span class="line"> --user=admin</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置默认上下文</span></span><br><span class="line">kubectl config use-context kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="4-2-创建kubeconfig文件"><a href="#4-2-创建kubeconfig文件" class="headerlink" title="4.2 创建kubeconfig文件"></a>4.2 创建kubeconfig文件</h2><h3 id="4-2-1-token"><a href="#4-2-1-token" class="headerlink" title="4.2.1 token"></a>4.2.1 token</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d <span class="string">' '</span>)</span><br><span class="line">cat &gt; token.csv &lt;&lt;EOF</span><br><span class="line"><span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span>,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<ul>
<li>在进行后续操作前请检查 token.csv 文件，确认其中的 ${BOOTSTRAP_TOKEN} 环境变量已经被真实的值替换。</li>
<li>BOOTSTRAP_TOKEN 将被写入到 kube-apiserver 使用的 token.csv 文件和 kubelet 使用的 bootstrap.kubeconfig 文件，如果后续重新生成了 BOOTSTRAP_TOKEN，则需要：<ul>
<li>更新 token.csv 文件，分发到所有机器 (master 和 node）的 /etc/kubernetes/ 目录下，分发到node节点上非必需；</li>
<li>重新生成 bootstrap.kubeconfig 文件，分发到所有 node 机器的 /etc/kubernetes/ 目录下；</li>
<li>重启 kube-apiserver 和 kubelet 进程；</li>
<li>重新 approve kubelet 的 csr 请求；</li>
</ul>
</li>
</ul>
<p>分发token到所有节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp token.csv /etc/kubernetes/</span><br><span class="line">scp /etc/kubernetes/token.csv root@/k8s2:/etc/kubernetes/</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-创建-kubelet-bootstrapping-kubeconfig-文件"><a href="#4-2-2-创建-kubelet-bootstrapping-kubeconfig-文件" class="headerlink" title="4.2.2 创建 kubelet bootstrapping kubeconfig 文件"></a>4.2.2 创建 kubelet bootstrapping kubeconfig 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes</span><br><span class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://10.233.1.75:6443"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>–embed-certs 为 true 时表示将 certificate-authority 证书写入到生成的 bootstrap.kubeconfig 文件中；</li>
<li>设置客户端认证参数时没有指定秘钥和证书，后续由 kube-apiserver 自动生成；</li>
</ul>
<h3 id="4-2-3-创建-kube-proxy-kubeconfig-文件"><a href="#4-2-3-创建-kube-proxy-kubeconfig-文件" class="headerlink" title="4.2.3 创建 kube-proxy kubeconfig 文件"></a>4.2.3 创建 kube-proxy kubeconfig 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://10.233.1.75:6443"</span></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \</span><br><span class="line">  --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>
<ul>
<li>设置集群参数和客户端认证参数时 –embed-certs 都为 true，这会将 certificate-authority、client-certificate 和 client-key 指向的证书文件内容写入到生成的 kube-proxy.kubeconfig 文件中；</li>
<li><p>kube-proxy.pem 证书中 CN 为 system:kube-proxy，kube-apiserver 预定义的 RoleBinding cluster-admin 将User system:kube-proxy 与 Role system:node-proxier 绑定，该 Role 授予了调用 kube-apiserver Proxy 相关 API 的权限；</p>
<p>分发 kubeconfig 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/kubernetes/*.kubeconfig root@k8s2:/etc/kubernetes/</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="5-kubernetes之Master安装"><a href="#5-kubernetes之Master安装" class="headerlink" title="5. kubernetes之Master安装"></a>5. kubernetes之Master安装</h1><h2 id="5-1-证书检查"><a href="#5-1-证书检查" class="headerlink" title="5.1 证书检查"></a>5.1 证书检查</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls /etc/kubernetes/ssl</span><br><span class="line">admin-key.pem  admin.pem  ca-key.pem  ca.pem  kube-proxy-key.pem  kube-proxy.pem  kubernetes-key.pem  kubernetes.pem</span><br></pre></td></tr></table></figure>
<h2 id="5-2-安装"><a href="#5-2-安装" class="headerlink" title="5.2 安装"></a>5.2 安装</h2><p><a href="https://kubernetes.io/docs/setup/release/notes/#server-binaries" target="_blank" rel="noopener">下载最新安装包</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cp -r server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure>
<h2 id="5-3-配置"><a href="#5-3-配置" class="headerlink" title="5.3 配置"></a>5.3 配置</h2><h3 id="5-3-1-config"><a href="#5-3-1-config" class="headerlink" title="5.3.1 config"></a>5.3.1 config</h3><p><code>/etc/kubernetes/config</code>文件,该配置文件同时被kube-apiserver、kube-controller-manager、kube-scheduler、kubelet、kube-proxy使用。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes system config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The following values are used to configure various aspects of all</span></span><br><span class="line"><span class="comment"># kubernetes services, including</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   kube-apiserver.service</span></span><br><span class="line"><span class="comment">#   kube-controller-manager.service</span></span><br><span class="line"><span class="comment">#   kube-scheduler.service</span></span><br><span class="line"><span class="comment">#   kubelet.service</span></span><br><span class="line"><span class="comment">#   kube-proxy.service</span></span><br><span class="line"><span class="comment"># logging to stderr means we get it in the systemd journal</span></span><br><span class="line"><span class="attr">KUBE_LOGTOSTDERR</span>=<span class="string">"--logtostderr=true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># journal message level, 0 is debug</span></span><br><span class="line"><span class="attr">KUBE_LOG_LEVEL</span>=<span class="string">"--v=0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Should this cluster be allowed to run privileged docker containers</span></span><br><span class="line"><span class="attr">KUBE_ALLOW_PRIV</span>=<span class="string">"--allow-privileged=true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># How the controller-manager, scheduler, and proxy find the apiserver</span></span><br><span class="line"><span class="comment">#KUBE_MASTER="--master=http://test-001.jimmysong.io:8080"</span></span><br><span class="line"><span class="attr">KUBE_MASTER</span>=<span class="string">"--master=http://10.233.1.75:8080"</span></span><br></pre></td></tr></table></figure>
<h2 id="5-4-apiserver"><a href="#5-4-apiserver" class="headerlink" title="5.4 apiserver"></a>5.4 apiserver</h2><h3 id="5-4-1-配置"><a href="#5-4-1-配置" class="headerlink" title="5.4.1 配置"></a>5.4.1 配置</h3><p><code>/etc/kubernetes/apiserver</code>内容为：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">## kubernetes system config</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## The following values are used to configure the kube-apiserver</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## The address on the local server to listen to.</span></span><br><span class="line"><span class="comment">#KUBE_API_ADDRESS="--insecure-bind-address=test-001.jimmysong.io"</span></span><br><span class="line"><span class="attr">KUBE_API_ADDRESS</span>=<span class="string">"--advertise-address=10.233.1.75 --bind-address=10.233.1.75 --insecure-bind-address=10.233.1.75"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## The port on the local server to listen on.</span></span><br><span class="line"><span class="comment">#KUBE_API_PORT="--port=8080"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## Port minions listen on</span></span><br><span class="line"><span class="comment">#KUBELET_PORT="--kubelet-port=10250"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## Comma separated list of nodes in the etcd cluster</span></span><br><span class="line"><span class="attr">KUBE_ETCD_SERVERS</span>=<span class="string">"--etcd-servers=https://10.233.1.75:2379,https://10.233.1.240:2379,https://10.233.1.99:2379"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## Address range to use for services</span></span><br><span class="line"><span class="attr">KUBE_SERVICE_ADDRESSES</span>=<span class="string">"--service-cluster-ip-range=192.168.0.1/16"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## default admission control policies</span></span><br><span class="line"><span class="attr">KUBE_ADMISSION_CONTROL</span>=<span class="string">"--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## Add your own!</span></span><br><span class="line"><span class="attr">KUBE_API_ARGS</span>=<span class="string">"--authorization-mode=Node,RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --enable-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem --client-ca-file=/etc/kubernetes/ssl/ca.pem --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem --etcd-cafile=/etc/kubernetes/ssl/ca.pem --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>–experimental-bootstrap-token-auth Bootstrap Token Authentication在1.9版本已经变成了正式feature，参数名称改为–enable-bootstrap-token-auth</li>
<li>如果中途修改过–service-cluster-ip-range地址，则必须将default命名空间的kubernetes的service给删除，使用命令：kubectl delete service kubernetes，然后系统会自动用新的ip重建这个service，不然apiserver的log有报错the cluster IP x.x.x.x for service kubernetes/default is not within the service CIDR x.x.x.x/16; please recreate</li>
<li>–authorization-mode=RBAC 指定在安全端口使用 RBAC 授权模式，拒绝未通过授权的请求；</li>
<li>kube-scheduler、kube-controller-manager 一般和 kube-apiserver 部署在同一台机器上，它们使用非安全端口和 kube-apiserver通信;</li>
<li>kubelet、kube-proxy、kubectl 部署在其它 Node 节点上，如果通过安全端口访问 kube-apiserver，则必须先通过 TLS 证书认证，再通过 RBAC 授权；</li>
<li>kube-proxy、kubectl 通过在使用的证书里指定相关的 User、Group 来达到通过 RBAC 授权的目的；</li>
<li>如果使用了 kubelet TLS Boostrap 机制，则不能再指定 –kubelet-certificate-authority、–kubelet-client-certificate 和 –kubelet-client-key 选项，否则后续 kube-apiserver 校验 kubelet 证书时出现 ”x509: certificate signed by unknown authority“ 错误；</li>
<li>–admission-control 值必须包含 ServiceAccount；</li>
<li>–bind-address 不能为 127.0.0.1；</li>
<li>runtime-config配置为rbac.authorization.k8s.io/v1beta1，表示运行时的apiVersion；</li>
<li>–service-cluster-ip-range 指定 Service Cluster IP 地址段，该地址段不能路由可达；</li>
<li>缺省情况下 kubernetes 对象保存在 etcd /registry 路径下，可以通过 –etcd-prefix 参数进行调整；</li>
<li><p>如果需要开通http的无认证的接口，则可以增加以下两个参数：–insecure-port=8080 –insecure-bind-address=127.0.0.1。注意，生产上不要绑定到非127.0.0.1的地址上</p>
<p>Kubernetes 1.9</p>
</li>
<li><p>对于Kubernetes1.9集群，需要注意配置KUBE_API_ARGS环境变量中的–authorization-mode=Node,RBAC，增加对Node授权的模式，否则将无法注册node。</p>
</li>
<li>–experimental-bootstrap-token-auth Bootstrap Token Authentication在kubernetes 1.9版本已经废弃，参数名称改为–enable-bootstrap-token-auth</li>
</ul>
<h3 id="5-4-2-apiserver-service"><a href="#5-4-2-apiserver-service" class="headerlink" title="5.4.2 apiserver.service"></a>5.4.2 apiserver.service</h3><p>创建<code>/usr/lib/systemd/system/kube-apiserver.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes API Service</span><br><span class="line"><span class="attr">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"><span class="attr">After</span>=etcd.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/config</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/apiserver</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/kube-apiserver \</span><br><span class="line">	    $KUBE_LOGTOSTDERR \</span><br><span class="line">	    $KUBE_LOG_LEVEL \</span><br><span class="line">	    $KUBE_ETCD_SERVERS \</span><br><span class="line">	    $KUBE_API_ADDRESS \</span><br><span class="line">	    $KUBE_API_PORT \</span><br><span class="line">	    $KUBELET_PORT \</span><br><span class="line">	    $KUBE_ALLOW_PRIV \</span><br><span class="line">	    $KUBE_SERVICE_ADDRESSES \</span><br><span class="line">	    $KUBE_ADMISSION_CONTROL \</span><br><span class="line">	    $KUBE_API_ARGS</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<h3 id="5-4-3-启动"><a href="#5-4-3-启动" class="headerlink" title="5.4.3 启动"></a>5.4.3 启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-apiserver</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl status kube-apiserver</span><br></pre></td></tr></table></figure>
<h2 id="5-5-kube-controller-manager"><a href="#5-5-kube-controller-manager" class="headerlink" title="5.5 kube-controller-manager"></a>5.5 kube-controller-manager</h2><h3 id="5-5-1-配置文件controller-manager"><a href="#5-5-1-配置文件controller-manager" class="headerlink" title="5.5.1 配置文件controller-manager"></a>5.5.1 配置文件controller-manager</h3><p>创建配置文件 <code>/etc/kubernetes/controller-manager</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># The following values are used to configure the kubernetes controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defaults from config and apiserver should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line"><span class="attr">KUBE_CONTROLLER_MANAGER_ARGS</span>=<span class="string">"--address=127.0.0.1 --service-cluster-ip-range=192.168.0.1/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem --root-ca-file=/etc/kubernetes/ssl/ca.pem --leader-elect=true"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>–service-cluster-ip-range 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致；</li>
<li>–cluster-signing-* 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥；</li>
<li>–root-ca-file 用来对 kube-apiserver 证书进行校验，指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件；</li>
<li>–address 值必须为 127.0.0.1，kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器；</li>
</ul>
<h3 id="5-5-2-启动服务"><a href="#5-5-2-启动服务" class="headerlink" title="5.5.2 启动服务"></a>5.5.2 启动服务</h3><p>创建 kube-controller-manager的serivce配置文件<br>/usr/lib/systemd/system/kube-controller-manager.service</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes Controller Manager</span><br><span class="line"><span class="attr">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/config</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/controller-manager</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/kube-controller-manager \</span><br><span class="line">        $KUBE_LOGTOSTDERR \</span><br><span class="line">        $KUBE_LOG_LEVEL \</span><br><span class="line">        $KUBE_MASTER \</span><br><span class="line">        $KUBE_CONTROLLER_MANAGER_ARGS</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<h3 id="5-5-3-启动"><a href="#5-5-3-启动" class="headerlink" title="5.5.3 启动"></a>5.5.3 启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-controller-manager</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl status kube-controller-manager</span><br></pre></td></tr></table></figure>
<h2 id="5-6-kube-scheduler"><a href="#5-6-kube-scheduler" class="headerlink" title="5.6 kube-scheduler"></a>5.6 kube-scheduler</h2><h3 id="5-6-1-配置scheduler"><a href="#5-6-1-配置scheduler" class="headerlink" title="5.6.1 配置scheduler"></a>5.6.1 配置scheduler</h3><p>配置文件/etc/kubernetes/scheduler</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes scheduler config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line"><span class="attr">KUBE_SCHEDULER_ARGS</span>=<span class="string">"--leader-elect=true --address=127.0.0.1"</span></span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>–address 值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器；</li>
</ul>
<h3 id="5-6-2-启动服务"><a href="#5-6-2-启动服务" class="headerlink" title="5.6.2 启动服务"></a>5.6.2 启动服务</h3><p>创建 kube-scheduler的serivce配置文件</p>
<p>文件路径/usr/lib/systemd/system/kube-scheduler.service。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler Plugin</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/config</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/scheduler</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \</span><br><span class="line">            $KUBE_LOGTOSTDERR \</span><br><span class="line">            $KUBE_LOG_LEVEL \</span><br><span class="line">            $KUBE_MASTER \</span><br><span class="line">            $KUBE_SCHEDULER_ARGS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
<h3 id="5-6-3-启动-kube-scheduler"><a href="#5-6-3-启动-kube-scheduler" class="headerlink" title="5.6.3 启动 kube-scheduler"></a>5.6.3 启动 kube-scheduler</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-scheduler</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl status kube-scheduler</span><br></pre></td></tr></table></figure>
<h2 id="5-7-验证master"><a href="#5-7-验证master" class="headerlink" title="5.7 验证master"></a>5.7 验证master</h2><p>kubectl get componentstatuses</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 kubernetes]<span class="comment"># kubectl get componentstatuses</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-Kubernetes之网络flannel安装"><a href="#6-Kubernetes之网络flannel安装" class="headerlink" title="6 Kubernetes之网络flannel安装"></a>6 Kubernetes之网络flannel安装</h1><h2 id="6-1-安装"><a href="#6-1-安装" class="headerlink" title="6.1 安装"></a>6.1 安装</h2><p>通过yum安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install flannel</span><br></pre></td></tr></table></figure>
<h2 id="6-2-配置"><a href="#6-2-配置" class="headerlink" title="6.2 配置"></a>6.2 配置</h2><p>/etc/sysconfig/flanneld</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Flanneld configuration options</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></span><br><span class="line"><span class="comment">#FLANNEL_ETCD_ENDPOINTS="http://127.0.0.1:2379"</span></span><br><span class="line"><span class="attr">FLANNEL_ETCD_ENDPOINTS</span>=<span class="string">"https://10.233.1.75:2379,https://10.233.1.240:2379,https://10.233.1.99:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></span><br><span class="line"><span class="comment"># For address range assignment</span></span><br><span class="line"><span class="comment">#FLANNEL_ETCD_PREFIX="/atomic.io/network"</span></span><br><span class="line"><span class="attr">FLANNEL_ETCD_PREFIX</span>=<span class="string">"/kube-centos/network"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Any additional options that you want to pass</span></span><br><span class="line"><span class="comment">#FLANNEL_OPTIONS=""</span></span><br><span class="line"><span class="attr">FLANNEL_OPTIONS</span>=<span class="string">"-etcd-cafile=/etc/kubernetes/ssl/ca.pem -etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem -etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem"</span></span><br></pre></td></tr></table></figure>
<h2 id="6-3-启动服务"><a href="#6-3-启动服务" class="headerlink" title="6.3 启动服务"></a>6.3 启动服务</h2><p>service配置文件<code>/usr/lib/systemd/system/flanneld.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Flanneld overlay address etcd agent</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">Wants</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">After</span>=etcd.service</span><br><span class="line"><span class="attr">Before</span>=docker.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="attr">EnvironmentFile</span>=/etc/sysconfig/flanneld</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/sysconfig/docker-network</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/flanneld-start <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line"><span class="attr">ExecStartPost</span>=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br><span class="line"><span class="attr">WantedBy</span>=docker.service</span><br></pre></td></tr></table></figure>
<h2 id="6-4-etcd配置"><a href="#6-4-etcd配置" class="headerlink" title="6.4 etcd配置"></a>6.4 etcd配置</h2><p>在etcd中创建网络配置</p>
<p>执行下面的命令为docker分配IP地址段。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/etcd/etcdctl --endpoints=https://10.233.1.75:2379,https://10.233.1.240:2379,https://10.233.1.99:2379 \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  mkdir /kube-centos/network</span><br><span class="line">/usr/<span class="built_in">local</span>/etcd/etcdctl --endpoints=https://10.233.1.75:2379,https://10.233.1.240:2379,https://10.233.1.99:2379 \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  mk /kube-centos/network/config <span class="string">'&#123;"Network":"192.168.0.1/16","SubnetLen":24,"Backend":&#123;"Type":"vxlan"&#125;&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="6-5-启动"><a href="#6-5-启动" class="headerlink" title="6.5 启动"></a>6.5 启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable flanneld</span><br><span class="line">systemctl start flanneld</span><br></pre></td></tr></table></figure>
<p>现在查询etcd中的内容可以看到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/etcd/etcdctl --endpoints=https://10.233.1.75:2379,https://10.233.1.240:2379,https://10.233.1.99:2379 \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  ls /kube-centos/network/subnets</span><br><span class="line">/kube-centos/network/subnets/192.168.88.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.71.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.57.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.8.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.25.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.18.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.70.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.22.0-24</span><br><span class="line">/kube-centos/network/subnets/192.168.103.0-24</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/etcd/etcdctl --endpoints=https://10.233.1.75:2379,https://10.233.1.240:2379,https://10.233.1.99:2379 \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  get /kube-centos/network/config</span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"192.168.0.1/16"</span>,<span class="string">"SubnetLen"</span>:24,<span class="string">"Backend"</span>:&#123;<span class="string">"Type"</span>:<span class="string">"host-gw"</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/etcd/etcdctl --endpoints=https://10.233.1.75:2379,https://10.233.1.240:2379,https://10.233.1.99:2379 \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  get /kube-centos/network/subnets/192.168.88.0-24</span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"10.233.1.240"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"7e:8b:c6:1b:f7:7f"</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/etcd/etcdctl --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  get /kube-centos/network/subnets/192.168.103.0-24</span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"10.233.1.144"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"0e:93:f7:7c:61:9d"</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="7-Kubernetes之Node安装"><a href="#7-Kubernetes之Node安装" class="headerlink" title="7 Kubernetes之Node安装"></a>7 Kubernetes之Node安装</h1><h2 id="7-1-Docker"><a href="#7-1-Docker" class="headerlink" title="7.1 Docker"></a>7.1 Docker</h2><h3 id="7-1-1-安装"><a href="#7-1-1-安装" class="headerlink" title="7.1.1 安装"></a>7.1.1 安装</h3><p>请参考docker<a href="https://docs.docker.com/install/linux/docker-ce/centos/#install-docker-ce" target="_blank" rel="noopener">官网安装</a>，建议新版，kubernetes 1.12版本支持到18.06</p>
<h3 id="7-1-2-网络配置"><a href="#7-1-2-网络配置" class="headerlink" title="7.1.2 网络配置"></a>7.1.2 网络配置</h3><p>修改 <code>/usr/lib/systemd/system/docker.service</code>适配flannel网络</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="section">[service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/run/flannel/subnet.env</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/run/flannel/docker</span><br><span class="line"><span class="comment"># the default is not to use systemd for cgroups because the delegate issues still</span></span><br><span class="line"><span class="comment"># exists and systemd currently does not support the cgroup feature set required</span></span><br><span class="line"><span class="comment"># for containers run by docker</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/dockerd --log-level=error <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>重新启动docer服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></p>
<h2 id="7-2-node安装"><a href="#7-2-node安装" class="headerlink" title="7.2 node安装"></a>7.2 node安装</h2><p>各node节点获取最新安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> kubernetes</span><br><span class="line">tar -xzvf  kubernetes-src.tar.gz</span><br><span class="line">cp -r kubernetes/node/bin/&#123;kube-proxy,kubelet,kubectl&#125; /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure>
<h3 id="7-2-1-kubelet"><a href="#7-2-1-kubelet" class="headerlink" title="7.2.1 kubelet"></a>7.2.1 kubelet</h3><h4 id="7-2-1-1"><a href="#7-2-1-1" class="headerlink" title="7.2.1.1"></a>7.2.1.1</h4><p>创建kubelet的service配置文件<br>文件位置/usr/lib/systemd/system/kubelet.service</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes Kubelet Server</span><br><span class="line"><span class="attr">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attr">After</span>=docker.service</span><br><span class="line"><span class="attr">Requires</span>=docker.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">WorkingDirectory</span>=/var/lib/kubelet</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/config</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/kubelet</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/kubelet \</span><br><span class="line">            $KUBE_LOGTOSTDERR \</span><br><span class="line">            $KUBE_LOG_LEVEL \</span><br><span class="line">            $KUBELET_API_SERVER \</span><br><span class="line">            $KUBELET_ADDRESS \</span><br><span class="line">            $KUBELET_PORT \</span><br><span class="line">            $KUBELET_HOSTNAME \</span><br><span class="line">            $KUBE_ALLOW_PRIV \</span><br><span class="line">            $KUBELET_POD_INFRA_CONTAINER \</span><br><span class="line">            $KUBELET_ARGS</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<h4 id="7-2-1-2-配置文件kubelet"><a href="#7-2-1-2-配置文件kubelet" class="headerlink" title="7.2.1.2 配置文件kubelet"></a>7.2.1.2 配置文件kubelet</h4><p>kubelet的配置文件/etc/kubernetes/kubelet。其中的IP地址更改为你的每台node节点的IP地址。</p>
<p>注意：在启动kubelet之前，需要先手动创建<code>/var/lib/kubelet</code>目录。</p>
<p>下面是kubelet的配置文件/etc/kubernetes/kubelet:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">## kubernetes kubelet (minion) config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></span><br><span class="line"><span class="attr">KUBELET_ADDRESS</span>=<span class="string">"--address=10.233.1.240"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## The port for the info server to serve on</span></span><br><span class="line"><span class="comment">#KUBELET_PORT="--port=10250"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## You may leave this blank to use the actual hostname</span></span><br><span class="line"><span class="attr">KUBELET_HOSTNAME</span>=<span class="string">"--hostname-override=10.233.1.240"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## location of the api-server</span></span><br><span class="line"><span class="comment">## COMMENT THIS ON KUBERNETES 1.8+</span></span><br><span class="line"><span class="comment">#KUBELET_API_SERVER="--api-servers=http://10.233.1.75:8080"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## pod infrastructure container</span></span><br><span class="line"><span class="attr">KUBELET_POD_INFRA_CONTAINER</span>=<span class="string">"--pod-infra-container-image=registry.cn-shenzhen.aliyuncs.com/zaife/pause-amd64:3.1"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## Add your own!</span></span><br><span class="line"><span class="attr">KUBELET_ARGS</span>=<span class="string">"--cluster-dns=192.168.0.2 --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig  --cert-dir=/etc/kubernetes/ssl --cluster-domain=cluster.local --hairpin-mode promiscuous-bridge --serialize-image-pulls=false"</span></span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>–experimental-bootstrap-kubeconfig 在1.9版本已经变成了–bootstrap-kubeconfig</li>
<li>–address 不能设置为 127.0.0.1，否则后续 Pods 访问 kubelet 的 API 接口时会失败，因为 Pods 访问的 127.0.0.1 指向自己而不是 kubelet；</li>
<li>如果设置了 –hostname-override 选项，则 kube-proxy 也需要设置该选项，否则会出现找不到 Node 的情况；</li>
<li>–bootstrap-kubeconfig 指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求；</li>
<li>管理员通过了 CSR 请求后，kubelet 自动在 –cert-dir 目录创建证书和私钥文件(kubelet-client.crt 和 kubelet-client.key)，然后写入 –kubeconfig 文件；</li>
<li>建议在 –kubeconfig 配置文件中指定 kube-apiserver 地址，如果未指定 –api-servers 选项，则必须指定 –require-kubeconfig 选项后才从配置文件中读取 kube-apiserver 的地址，否则 kubelet 启动后将找不到 kube-apiserver (日志中提示未找到 API Server），kubectl get nodes 不会返回对应的 Node 信息; –require-kubeconfig 在1.10版本被移除，参看PR；</li>
<li>–cluster-dns 指定 kubedns 的 Service IP(可以先分配，后续创建 kubedns 服务时指定该 IP)，–cluster-domain 指定域名后缀，这两个参数同时指定后才会生效；</li>
<li>–cluster-domain 指定 pod 启动时 /etc/resolve.conf 文件中的 search domain ，起初我们将其配置成了 cluster.local.，这样在解析 service 的 DNS 名称时是正常的，可是在解析 headless service 中的 FQDN pod name 的时候却错误，因此我们将其修改为 cluster.local，去掉最后面的 ”点号“ 就可以解决该问题，关于 kubernetes 中的域名/服务名称解析请参见我的另一篇文章。</li>
<li>–kubeconfig=/etc/kubernetes/kubelet.kubeconfig中指定的kubelet.kubeconfig文件在第一次启动kubelet之前并不存在，请看下文，当通过CSR请求后会自动生成kubelet.kubeconfig文件，如果你的节点上已经生成了~/.kube/config文件，你可以将该文件拷贝到该路径下，并重命名为kubelet.kubeconfig，所有node节点可以共用同一个kubelet.kubeconfig文件，这样新添加的节点就不需要再创建CSR请求就能自动添加到kubernetes集群中。同样，在任意能够访问到kubernetes集群的主机上使用kubectl –kubeconfig命令操作集群时，只要使用~/.kube/config文件就可以通过权限认证，因为这里面已经有认证信息并认为你是admin用户，对集群拥有所有权限。<ul>
<li>KUBELET_POD_INFRA_CONTAINER 是基础镜像容器，这里是采用阿里云容器镜像服务自己制作的</li>
</ul>
</li>
</ul>
<h4 id="7-2-1-3-启动kubelet"><a href="#7-2-1-3-启动kubelet" class="headerlink" title="7.2.1.3 启动kubelet"></a>7.2.1.3 启动kubelet</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl status kubelet</span><br></pre></td></tr></table></figure>
<h3 id="7-2-2-kube-proxy安装"><a href="#7-2-2-kube-proxy安装" class="headerlink" title="7.2.2 kube-proxy安装"></a>7.2.2 kube-proxy安装</h3><p>安装conntrack</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y conntrack-tools</span><br></pre></td></tr></table></figure>
<h4 id="7-2-2-1-启动服务"><a href="#7-2-2-1-启动服务" class="headerlink" title="7.2.2.1 启动服务"></a>7.2.2.1 启动服务</h4><p>文件路径<code>/usr/lib/systemd/system/kube-proxy.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Kubernetes Kube-Proxy Server</span><br><span class="line"><span class="attr">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/config</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/kubernetes/proxy</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/kube-proxy \</span><br><span class="line">        $KUBE_LOGTOSTDERR \</span><br><span class="line">        $KUBE_LOG_LEVEL \</span><br><span class="line">        $KUBE_MASTER \</span><br><span class="line">        $KUBE_PROXY_ARGS</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<h4 id="7-2-2-2-配置"><a href="#7-2-2-2-配置" class="headerlink" title="7.2.2.2 配置"></a>7.2.2.2 配置</h4><p>kube-proxy配置文件<code>/etc/kubernetes/proxy</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment"># kubernetes proxy config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default config should be adequate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add your own!</span></span><br><span class="line"><span class="attr">KUBE_PROXY_ARGS</span>=<span class="string">"--bind-address=10.233.1.240 --hostname-override=10.233.1.240 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig --cluster-cidr=192.168.0.1/16"</span></span><br></pre></td></tr></table></figure>
<h4 id="7-2-2-3启动"><a href="#7-2-2-3启动" class="headerlink" title="7.2.2.3启动"></a>7.2.2.3启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl status kube-proxy</span><br></pre></td></tr></table></figure>
<h3 id="7-2-3-通过kubelet的TLS请求"><a href="#7-2-3-通过kubelet的TLS请求" class="headerlink" title="7.2.3 通过kubelet的TLS请求"></a>7.2.3 通过kubelet的TLS请求</h3><p>kubelet 首次启动时向 kube-apiserver 发送证书签名请求，必须通过后 kubernetes 系统才会将该 Node 加入到集群。</p>
<p>查看未授权的 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get csr</span><br><span class="line">NAME        AGE       REQUESTOR           CONDITION</span><br><span class="line">csr-2b308   4m        kubelet-bootstrap   Pending</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure>
<p>通过 CSR 请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl certificate approve csr-2b308</span><br><span class="line">certificatesigningrequest <span class="string">"csr-2b308"</span> approved</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">NAME        STATUS    AGE       VERSION</span><br><span class="line">10.64.3.7   Ready     49m       v1.6.1</span><br></pre></td></tr></table></figure>
<p>自动生成了 kubelet kubeconfig 文件和公私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line">-rw------- 1 root root 2294 Oct 30 16:47 kubelet.kubeconfig</span><br><span class="line">$ ls -l /etc/kubernetes/ssl/kubelet*</span><br><span class="line">-rw------- 1 root root 1273 Oct 30 16:47 kubelet-client-2018-10-30-16-47-28.pem</span><br><span class="line">lrwxrwxrwx 1 root root   58 Oct 30 16:47 kubelet-client-current.pem -&gt; /etc/kubernetes/ssl/kubelet-client-2018-10-30-16-47-28.pem</span><br><span class="line">-rw-r--r-- 1 root root 2181 Oct 30 16:47 kubelet.crt</span><br><span class="line">-rw------- 1 root root 1679 Oct 30 16:47 kubelet.key</span><br></pre></td></tr></table></figure>
<p>假如你更新kubernetes的证书，只要没有更新token.csv，当重启kubelet后，该node就会自动加入到kuberentes集群中，而不会重新发送certificaterequest，也不需要在master节点上执行kubectl certificate approve操作。前提是不要删除node节点上的/etc/kubernetes/ssl/kubelet*和/etc/kubernetes/kubelet.kubeconfig文件。否则kubelet启动时会提示找不到证书而失败。</p>
<p>注意：如果启动kubelet的时候见到证书相关的报错，有个trick可以解决这个问题，可以将master节点上的~/.kube/config文件（该文件在安装kubectl命令行工具这一步中将会自动生成）拷贝到node节点的/etc/kubernetes/kubelet.kubeconfig位置，这样就不需要通过CSR，当kubelet启动后就会自动加入的集群中。</p>
<h1 id="8-Kubernetes之插件安装"><a href="#8-Kubernetes之插件安装" class="headerlink" title="8 Kubernetes之插件安装"></a>8 Kubernetes之插件安装</h1><h2 id="8-1-kube-dns插件"><a href="#8-1-kube-dns插件" class="headerlink" title="8.1 kube-dns插件"></a>8.1 kube-dns插件</h2><p>kube-dns插件使用kubernetes部署，官方的配置文件包含以下镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 kube-dns]<span class="comment"># cat kube-dns.yaml.base | grep image</span></span><br><span class="line">        image: k8s.gcr.io/k8s-dns-kube-dns:1.14.13</span><br><span class="line">        image: k8s.gcr.io/k8s-dns-dnsmasq-nanny:1.14.13</span><br><span class="line">        image: k8s.gcr.io/k8s-dns-sidecar:1.14.13</span><br></pre></td></tr></table></figure>
<p>由于国内原因，需要我们pull下来相关镜像，上传到私有仓库，这里使用阿里云容器镜像服务。</p>
<h3 id="8-1-1-kube-dns-yaml"><a href="#8-1-1-kube-dns-yaml" class="headerlink" title="8.1.1 kube-dns.yaml"></a>8.1.1 kube-dns.yaml</h3><p>下载基础文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dns/kube-dns/kube-dns.yaml.base</span><br><span class="line"></span><br><span class="line">cp kube-dns.yaml.base kube-dns.yaml</span><br></pre></td></tr></table></figure>
<p>修改kube-dns.yaml<br>主要修改的地方</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 kube-dns]<span class="comment"># diff kube-dns.yaml kube-dns.yaml.base</span></span><br><span class="line"></span><br><span class="line">14c33</span><br><span class="line">&lt;   clusterIP: 192.168.0.2</span><br><span class="line">---</span><br><span class="line">&gt;   clusterIP: __PILLAR__DNS__SERVER__</span><br><span class="line">80c99</span><br><span class="line">&lt;         image: registry.cn-shenzhen.aliyuncs.com/zaife/k8s-dns-kube-dns-amd64:1.14.13</span><br><span class="line">---</span><br><span class="line">&gt;         image: k8s.gcr.io/k8s-dns-kube-dns:1.14.13</span><br><span class="line">110c129</span><br><span class="line">&lt;         - --domain=cluster.local.</span><br><span class="line">---</span><br><span class="line">&gt;         - --domain=__PILLAR__DNS__DOMAIN__.</span><br><span class="line">131c150</span><br><span class="line">&lt;         image: registry.cn-shenzhen.aliyuncs.com/zaife/k8s-dns-dnsmasq-nanny-amd64:1.14.13</span><br><span class="line">---</span><br><span class="line">&gt;         image: k8s.gcr.io/k8s-dns-dnsmasq-nanny:1.14.13</span><br><span class="line">152c171</span><br><span class="line">&lt;         - --server=/cluster.local./127.0.0.1<span class="comment">#10053</span></span><br><span class="line">---</span><br><span class="line">&gt;         - --server=/__PILLAR__DNS__DOMAIN__/127.0.0.1<span class="comment">#10053</span></span><br><span class="line">171c190</span><br><span class="line">&lt;         image: registry.cn-shenzhen.aliyuncs.com/zaife/k8s-dns-sidecar-amd64:1.14.13</span><br><span class="line">---</span><br><span class="line">&gt;         image: k8s.gcr.io/k8s-dns-sidecar:1.14.13</span><br><span class="line">184,185c203,204</span><br><span class="line">&lt;         - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.cluster.local.,5,SRV</span><br><span class="line">&lt;         - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.cluster.local.,5,SRV</span><br><span class="line">---</span><br><span class="line">&gt;         - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.__PILLAR__DNS__DOMAIN__,5,SRV</span><br><span class="line">&gt;         - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.__PILLAR__DNS__DOMAIN__,5,SRV</span><br></pre></td></tr></table></figure>
<h3 id="8-1-2-权限"><a href="#8-1-2-权限" class="headerlink" title="8.1.2 权限"></a>8.1.2 权限</h3><p>预定义的 RoleBinding system:kube-dns 将 kube-system 命名空间的 kube-dns ServiceAccount 与 ystem:kube-dns Role 绑定， 该 Role 具有访问 kube-apiserver DNS 相关 API 的权限；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 kube-dns]<span class="comment"># kubectl get clusterrolebindings system:kube-dns -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: <span class="string">"true"</span></span><br><span class="line">  creationTimestamp: 2018-10-30T07:37:10Z</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-dns</span><br><span class="line">  resourceVersion: <span class="string">"99"</span></span><br><span class="line">  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Akube-dns</span><br><span class="line">  uid: 9c91b1a9-dc16-11e8-b223-fa163ea6f6eb</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-dns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>
<h3 id="8-1-3-执行"><a href="#8-1-3-执行" class="headerlink" title="8.1.3 执行"></a>8.1.3 执行</h3><p>通过kubectl执行部署kube-dns服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kube-dns.yaml</span><br></pre></td></tr></table></figure>
<h3 id="8-1-4-验证"><a href="#8-1-4-验证" class="headerlink" title="8.1.4 验证"></a>8.1.4 验证</h3><p>可以检查发现，kube-dns容器已经启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 kube-dns]# kubectl get pods -n kube-system | grep dns</span><br><span class="line">kube-dns-7d4878d944-j64z7               3/3     Running   0          24h</span><br></pre></td></tr></table></figure></p>
<h3 id="8-1-5-检查"><a href="#8-1-5-检查" class="headerlink" title="8.1.5 检查"></a>8.1.5 检查</h3><p>创建一个简单的Pod作测试</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    command:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sleep</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"3600"</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>
<p>创建pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f busybox.yaml</span><br><span class="line">pod <span class="string">"busybox"</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl get pods busybox</span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE</span><br><span class="line">busybox   1/1       Running   0          &lt;some-time&gt;</span><br></pre></td></tr></table></figure>
<p>一旦该 pod 运行，您就可以在环境中执行 nslookup。如果您看到如下所示的内容，则 DNS 工作正常。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 kube-dns]<span class="comment"># kubectl exec -ti busybox -- nslookup kubernetes.default</span></span><br><span class="line">Server:    192.168.0.2</span><br><span class="line">Address 1: 192.168.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 192.168.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure></p>
<p>nslookup正常</p>
<p>可以通过如下，查看是否有错误日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs --namespace=kube-system $(kubectl get pods --namespace=kube-system -l k8s-app=kube-dns -o name) -c kubedns</span><br><span class="line">kubectl logs --namespace=kube-system $(kubectl get pods --namespace=kube-system -l k8s-app=kube-dns -o name) -c dnsmasq</span><br><span class="line">kubectl logs --namespace=kube-system $(kubectl get pods --namespace=kube-system -l k8s-app=kube-dns -o name) -c sidecar</span><br></pre></td></tr></table></figure></p>
<h2 id="8-2-dashboard插件"><a href="#8-2-dashboard插件" class="headerlink" title="8.2 dashboard插件"></a>8.2 dashboard插件</h2><h3 id="8-2-1-yaml文件"><a href="#8-2-1-yaml文件" class="headerlink" title="8.2.1 yaml文件"></a>8.2.1 yaml文件</h3><p>官方目录 <a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dashboard</a></p>
<p>需要使用的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard-configmap.yaml  dashboard-controller.yaml  dashboard-rbac.yaml  dashboard-secret.yaml  dashboard-service.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>dashboard-configmap.yaml</li>
<li>dashboard-controller.yaml</li>
<li>dashboard-rbac.yaml</li>
<li>dashboard-secret.yaml</li>
<li>dashboard-service.yaml</li>
</ul>
<p>dashboard使用的镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 dashboard]<span class="comment"># cat dashboard-controller.yaml |grep image</span></span><br><span class="line">        image: k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.3</span><br></pre></td></tr></table></figure>
<p>需要替换为私有镜像</p>
<h3 id="8-2-2-执行，安装插件"><a href="#8-2-2-执行，安装插件" class="headerlink" title="8.2.2 执行，安装插件"></a>8.2.2 执行，安装插件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f .</span><br><span class="line"></span><br><span class="line">[root@k8s1 dashboard]<span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">...</span><br><span class="line">kubernetes-dashboard-6dbdc9cdb6-f5h9r   1/1     Running   0          27h</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="8-2-3-登录"><a href="#8-2-3-登录" class="headerlink" title="8.2.3 登录"></a>8.2.3 登录</h3><p>dashboard有几种登录方式，可以采用token方式</p>
<ul>
<li>kubernetes-dashboard 服务暴露了 NodePort，可以使用 <a href="http://NodeIP:nodePort" target="_blank" rel="noopener">http://NodeIP:nodePort</a> 地址访问 dashboard</li>
<li>通过 API server 访问 dashboard（https 6443端口和http 8080端口方式）</li>
<li>通过 kubectl proxy 访问 dashboard</li>
</ul>
<p>获取token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 dashboard]<span class="comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep kubernetes-dashboard-token|awk '&#123;print $1&#125;')|grep token:|awk '&#123;print $2&#125;'</span></span><br><span class="line"></span><br><span class="line">ey......SQ</span><br></pre></td></tr></table></figure>
<p>很长的这个字符串就是了</p>
<p>通过 API server 访问dashboard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 dashboard]<span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://10.233.1.75:6443</span><br><span class="line">Heapster is running at https://10.233.1.75:6443/api/v1/namespaces/kube-system/services/heapster/proxy</span><br><span class="line">KubeDNS is running at https://10.233.1.75:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line">kubernetes-dashboard is running at https://10.233.1.75:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy</span><br></pre></td></tr></table></figure>
<p>浏览器访问 <a href="https://10.233.1.75:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy，通过之前获取token就可以登录" target="_blank" rel="noopener">https://10.233.1.75:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy，通过之前获取token就可以登录</a></p>
<h2 id="8-3-heapster插件"><a href="#8-3-heapster插件" class="headerlink" title="8.3 heapster插件"></a>8.3 heapster插件</h2><p>在k8s集群中安装了kubernetes-dashboard插件，进入到了dashboard的界面中去了。但是我们查看kubernetes-dashboard的log,会发现有下面这样的记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">2018/04/29 01:56:10 No metric client provided. Skipping metrics.</span><br><span class="line">2018/04/29 01:56:10 No metric client provided. Skipping metrics.</span><br><span class="line">2018/04/29 01:56:10 [2018-04-29T01:56:10Z] Outcoming response to 10.32.0.1:49022 with 200 status code</span><br><span class="line">2018/04/29 01:56:38 Metric client health check failed: the server could not find the requested resource (get services heapster). Retrying in 30 seconds.</span><br></pre></td></tr></table></figure>
<p>从上面的log中我们大致可以得出如下的信息:当前系统中没有用于获取监控信息指标的客户端(metric client)，所以kubernetes-dashboard的处理方式是跳过这一步。同时，对metric client的健康检查失败了。这些问题不会导致dashboard无法工作，只是kubernetes-dashboard获取不到系统以及各个pod的监控数据。这里的解决方案就是安装另外一个k8s插件－－heapster.</p>
<p>Heapster是容器集群监控和性能分析工具，天然的支持Kubernetes和CoreOS。</p>
<h3 id="8-3-1-yml和镜像"><a href="#8-3-1-yml和镜像" class="headerlink" title="8.3.1 yml和镜像"></a>8.3.1 yml和镜像</h3><p>下载yml</p>
<p><a href="https://github.com/kubernetes/heapster/tree/master/deploy/kube-config/influxdb" target="_blank" rel="noopener">https://github.com/kubernetes/heapster/tree/master/deploy/kube-config/influxdb</a> 下3个文件</p>
<ul>
<li>grafana.yaml</li>
<li>heapster.yaml</li>
<li>influxdb.yaml</li>
</ul>
<p><a href="https://github.com/kubernetes/heapster/tree/master/deploy/kube-config/rbac" target="_blank" rel="noopener">https://github.com/kubernetes/heapster/tree/master/deploy/kube-config/rbac</a></p>
<ul>
<li>heapster-rbac.yaml</li>
</ul>
<p>涉及的镜像</p>
<ul>
<li>k8s.gcr.io/heapster-grafana-amd64:v5.0.4</li>
<li>k8s.gcr.io/heapster-amd64:v1.5.4</li>
<li>k8s.gcr.io/heapster-influxdb-amd64:v1.5.2</li>
</ul>
<p>需要替换为私有镜像<br>下载地址 <a href="https://console.cloud.google.com/gcr/images/google-containers/GLOBAL/" target="_blank" rel="noopener">https://console.cloud.google.com/gcr/images/google-containers/GLOBAL/</a></p>
<h3 id="8-3-2-安装"><a href="#8-3-2-安装" class="headerlink" title="8.3.2 安装"></a>8.3.2 安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f .</span><br></pre></td></tr></table></figure>
<h3 id="8-3-3-验证"><a href="#8-3-3-验证" class="headerlink" title="8.3.3 验证"></a>8.3.3 验证</h3><p>  登录dashboard，就可以看到图表形式展示的系统，各个pod的实时监控数据。</p>
<h1 id="9-问题"><a href="#9-问题" class="headerlink" title="9. 问题"></a>9. 问题</h1><h2 id="9-1-镜像下载"><a href="#9-1-镜像下载" class="headerlink" title="9.1 镜像下载"></a>9.1 镜像下载</h2><p>需要从gcr.io下载镜像，国内网络不通。</p>
<p>源：<a href="https://console.cloud.google.com/gcr/images/google-containers/GLOBAL/" target="_blank" rel="noopener">https://console.cloud.google.com/gcr/images/google-containers/GLOBAL/</a></p>
<p>通过docker pull下载到本地</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull gcr.io/google-containers/heapster-amd64:v1.5.4</span><br><span class="line">docker tag xxxxx xxxxxxx/heapster-amd64:v1.5.4</span><br><span class="line">docker push xxxxxxx/heapster-amd64:v1.5.4</span><br></pre></td></tr></table></figure>
<p>这里使用了阿里云容器镜像服务，暂时免费。</p>
<h2 id="9-2-dashboard证书"><a href="#9-2-dashboard证书" class="headerlink" title="9.2 dashboard证书"></a>9.2 dashboard证书</h2><p>dashboard需要证书登录，期间浏览器登录一直没有响应，最后还是通过6443走https访问</p>
<h2 id="9-3-kube-dns和网络"><a href="#9-3-kube-dns和网络" class="headerlink" title="9.3 kube-dns和网络"></a>9.3 kube-dns和网络</h2><p>dns安装好后，服务nslookup kubernetes.default</p>
<p>原因：docker.0和flannel.1不在同一网段，下面是修正过的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s1 dashboard]<span class="comment"># ip addr show</span></span><br><span class="line">1: lo: ...</span><br><span class="line">2: eth0: ...</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP</span><br><span class="line">    link/ether 02:42:1f:12:9e:df brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.8.1/24 brd 192.168.8.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:1fff:fe12:9edf/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN</span><br><span class="line">    link/ether 06:c3:3f:74:ac:43 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.42.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.8.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4c3:3fff:fe74:ac43/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: ....</span><br></pre></td></tr></table></figure>
<p>解决办法：docker配置不对，service后忘记添加启动参数 <strong>$DOCKER_NETWORK_OPTIONS</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">EnvironmentFile</span>=-/run/flannel/subnet.env</span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/run/flannel/docker</span><br><span class="line"><span class="comment"># the default is not to use systemd for cgroups because the delegate issues still</span></span><br><span class="line"><span class="comment"># exists and systemd currently does not support the cgroup feature set required</span></span><br><span class="line"><span class="comment"># for containers run by docker</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/dockerd --log-level=error <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br></pre></td></tr></table></figure>
<h1 id="10-参考资料"><a href="#10-参考资料" class="headerlink" title="10. 参考资料"></a>10. 参考资料</h1><ol>
<li><a href="https://jimmysong.io/kubernetes-handbook/practice/install-kubernetes-on-centos.html" target="_blank" rel="noopener">宋净超 kubernetes-hand book</a></li>
<li>[官方文档]<a href="https://kubernetes.io/docs/" target="_blank" rel="noopener">https://kubernetes.io/docs/</a>)</li>
<li><a href="https://hk.saowen.com/a/ec55bc4cfa28660a82fe021ef9595c65dda5a0ece18c175ed06bae403ac68503" target="_blank" rel="noopener">kubernetes-dashboard(1.8.3)部署與踩坑</a></li>
<li><a href="https://andrewpqc.github.io/categories/Kubernetes/" target="_blank" rel="noopener">https://andrewpqc.github.io/categories/Kubernetes/</a></li>
<li><a href="https://console.cloud.google.com/gcr/images/google-containers/GLOBAL/" target="_blank" rel="noopener">https://console.cloud.google.com/gcr/images/google-containers/GLOBAL/</a></li>
<li><a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="noopener">和我一步步部署 kubernetes 集群</a></li>
</ol>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/IMG_5231.JPG" alt="zaife WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/IMG_5232.JPG" alt="zaife Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/09/effective-java-third-1/" rel="next" title="Effective Java Third Edition(1)">
                <i class="fa fa-chevron-left"></i> Effective Java Third Edition(1)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/32269?v=3&s=460"
               alt="zaife" />
          <p class="site-author-name" itemprop="name">zaife</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zaife" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/zaifebird" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                    
                      Twitter
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1497068093" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-环境准备"><span class="nav-number">1.</span> <span class="nav-text">1.环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1服务器规划"><span class="nav-number">1.1.</span> <span class="nav-text">1.1服务器规划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-服务器环境"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 服务器环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-关闭selinux"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 关闭selinux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-关闭swap"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 关闭swap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-防火墙"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-host解析"><span class="nav-number">1.2.4.</span> <span class="nav-text">1.2.4 host解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-5-系统参数"><span class="nav-number">1.2.5.</span> <span class="nav-text">1.2.5 系统参数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-证书准备"><span class="nav-number">2.</span> <span class="nav-text">2 证书准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-证书列表"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 证书列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-安装CFSSL"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 安装CFSSL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-证书生成"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 证书生成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-创建CA配置文件"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1 创建CA配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-CA证书签名"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.3.2 CA证书签名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-生成CA证书和私钥"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3.3 生成CA证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-4-创建kubernetes证书"><span class="nav-number">2.3.4.</span> <span class="nav-text">2.3.4 创建kubernetes证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-5-生成kubernetes证书和私钥"><span class="nav-number">2.3.5.</span> <span class="nav-text">2.3.5 生成kubernetes证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-6-创建admin证书"><span class="nav-number">2.3.6.</span> <span class="nav-text">2.3.6 创建admin证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-7-生成admin证书和私钥"><span class="nav-number">2.3.7.</span> <span class="nav-text">2.3.7 生成admin证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-8-创建kube-proxy证书"><span class="nav-number">2.3.8.</span> <span class="nav-text">2.3.8 创建kube-proxy证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-9生成证书和私钥"><span class="nav-number">2.3.9.</span> <span class="nav-text">2.3.9生成证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-10-校验证书"><span class="nav-number">2.3.10.</span> <span class="nav-text">2.3.10 校验证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-11-分发证书"><span class="nav-number">2.3.11.</span> <span class="nav-text">2.3.11 分发证书</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Etcd安装"><span class="nav-number">3.</span> <span class="nav-text">3 Etcd安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-集群环境"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 集群环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-安装"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-配置文件"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-配置启动脚本"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 配置启动脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-启动"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-验证集群状态"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 验证集群状态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-kubernetes之kubectl安装和kubeconfig配置"><span class="nav-number">4.</span> <span class="nav-text">4. kubernetes之kubectl安装和kubeconfig配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-创建kubeconfig文件"><span class="nav-number">4.1.</span> <span class="nav-text">4.2 创建kubeconfig文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-token"><span class="nav-number">4.1.1.</span> <span class="nav-text">4.2.1 token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-创建-kubelet-bootstrapping-kubeconfig-文件"><span class="nav-number">4.1.2.</span> <span class="nav-text">4.2.2 创建 kubelet bootstrapping kubeconfig 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-创建-kube-proxy-kubeconfig-文件"><span class="nav-number">4.1.3.</span> <span class="nav-text">4.2.3 创建 kube-proxy kubeconfig 文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-kubernetes之Master安装"><span class="nav-number">5.</span> <span class="nav-text">5. kubernetes之Master安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-证书检查"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 证书检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-安装"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-配置"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-config"><span class="nav-number">5.3.1.</span> <span class="nav-text">5.3.1 config</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-apiserver"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 apiserver</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-1-配置"><span class="nav-number">5.4.1.</span> <span class="nav-text">5.4.1 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-2-apiserver-service"><span class="nav-number">5.4.2.</span> <span class="nav-text">5.4.2 apiserver.service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-3-启动"><span class="nav-number">5.4.3.</span> <span class="nav-text">5.4.3 启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-kube-controller-manager"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 kube-controller-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-1-配置文件controller-manager"><span class="nav-number">5.5.1.</span> <span class="nav-text">5.5.1 配置文件controller-manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-2-启动服务"><span class="nav-number">5.5.2.</span> <span class="nav-text">5.5.2 启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-3-启动"><span class="nav-number">5.5.3.</span> <span class="nav-text">5.5.3 启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-kube-scheduler"><span class="nav-number">5.6.</span> <span class="nav-text">5.6 kube-scheduler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-1-配置scheduler"><span class="nav-number">5.6.1.</span> <span class="nav-text">5.6.1 配置scheduler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-2-启动服务"><span class="nav-number">5.6.2.</span> <span class="nav-text">5.6.2 启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-3-启动-kube-scheduler"><span class="nav-number">5.6.3.</span> <span class="nav-text">5.6.3 启动 kube-scheduler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-7-验证master"><span class="nav-number">5.7.</span> <span class="nav-text">5.7 验证master</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-Kubernetes之网络flannel安装"><span class="nav-number">6.</span> <span class="nav-text">6 Kubernetes之网络flannel安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-安装"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-配置"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-启动服务"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 启动服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-etcd配置"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 etcd配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-启动"><span class="nav-number">6.5.</span> <span class="nav-text">6.5 启动</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-Kubernetes之Node安装"><span class="nav-number">7.</span> <span class="nav-text">7 Kubernetes之Node安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-Docker"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 Docker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-1-安装"><span class="nav-number">7.1.1.</span> <span class="nav-text">7.1.1 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-2-网络配置"><span class="nav-number">7.1.2.</span> <span class="nav-text">7.1.2 网络配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-node安装"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 node安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-1-kubelet"><span class="nav-number">7.2.1.</span> <span class="nav-text">7.2.1 kubelet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-1"><span class="nav-number">7.2.1.1.</span> <span class="nav-text">7.2.1.1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-2-配置文件kubelet"><span class="nav-number">7.2.1.2.</span> <span class="nav-text">7.2.1.2 配置文件kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-3-启动kubelet"><span class="nav-number">7.2.1.3.</span> <span class="nav-text">7.2.1.3 启动kubelet</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-2-kube-proxy安装"><span class="nav-number">7.2.2.</span> <span class="nav-text">7.2.2 kube-proxy安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-1-启动服务"><span class="nav-number">7.2.2.1.</span> <span class="nav-text">7.2.2.1 启动服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-2-配置"><span class="nav-number">7.2.2.2.</span> <span class="nav-text">7.2.2.2 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-3启动"><span class="nav-number">7.2.2.3.</span> <span class="nav-text">7.2.2.3启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-3-通过kubelet的TLS请求"><span class="nav-number">7.2.3.</span> <span class="nav-text">7.2.3 通过kubelet的TLS请求</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-Kubernetes之插件安装"><span class="nav-number">8.</span> <span class="nav-text">8 Kubernetes之插件安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-kube-dns插件"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 kube-dns插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-kube-dns-yaml"><span class="nav-number">8.1.1.</span> <span class="nav-text">8.1.1 kube-dns.yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-权限"><span class="nav-number">8.1.2.</span> <span class="nav-text">8.1.2 权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-3-执行"><span class="nav-number">8.1.3.</span> <span class="nav-text">8.1.3 执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-4-验证"><span class="nav-number">8.1.4.</span> <span class="nav-text">8.1.4 验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-5-检查"><span class="nav-number">8.1.5.</span> <span class="nav-text">8.1.5 检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-dashboard插件"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 dashboard插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1-yaml文件"><span class="nav-number">8.2.1.</span> <span class="nav-text">8.2.1 yaml文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-2-执行，安装插件"><span class="nav-number">8.2.2.</span> <span class="nav-text">8.2.2 执行，安装插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-3-登录"><span class="nav-number">8.2.3.</span> <span class="nav-text">8.2.3 登录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-heapster插件"><span class="nav-number">8.3.</span> <span class="nav-text">8.3 heapster插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-1-yml和镜像"><span class="nav-number">8.3.1.</span> <span class="nav-text">8.3.1 yml和镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-2-安装"><span class="nav-number">8.3.2.</span> <span class="nav-text">8.3.2 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-3-验证"><span class="nav-number">8.3.3.</span> <span class="nav-text">8.3.3 验证</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-问题"><span class="nav-number">9.</span> <span class="nav-text">9. 问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-镜像下载"><span class="nav-number">9.1.</span> <span class="nav-text">9.1 镜像下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-dashboard证书"><span class="nav-number">9.2.</span> <span class="nav-text">9.2 dashboard证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-kube-dns和网络"><span class="nav-number">9.3.</span> <span class="nav-text">9.3 kube-dns和网络</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-参考资料"><span class="nav-number">10.</span> <span class="nav-text">10. 参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zaife</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  








  






  





  

  

  

  

  

  

</body>
</html>
